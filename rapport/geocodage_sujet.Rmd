---
title: "Geocodage Sujet Gouramic"
author: "Olivier Leroy"
date: "19 mars 2020"
lang: fr-FR
output: 
    bookdown::html_document2:
        theme: readable
        toc: true
        toc_float: true
        number_sections: true
        toc_depth: 3
        fig_caption: true
        keep_md: true
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pkgs <-  c("dplyr","stringr", "lubridate", "ggplot2", "sf")
inst <- lapply(pkgs, library, character.only = TRUE)
```

C'est un document de travail. Ses objectifs sont : 

* Communiquer entre l'equipe 
* Garder traces des différentes modifications sur le jeux de données et des operations pour le geocodage
* Identifier des contraintes pour la construction de la base et des analyses qui suivront


# Présentation du jeux de données 

```{r chargement des données}
# c'est un fichier un peu nettoyer et reorganiser cf detail
# Prétraitement_etl/clean_order_all_sujet.r
allsujet_clean.dat <- readRDS("../data/allsujet_clean.rds")

```


## Source des données 

Le geocodage c'est fait à partir d'un jeu de données constitué via des enquêtes telephoniques [si on a une ref.]. La nature meme des intérrogations comme savoir où habitaient certains sujets lors de leur naissance fait qu'il y a des manques dans le jeu de données (meme si dans la mesure du possible un des parents était présent [à confirmer]). 


## Nombre d'adresse par sujet

Ce jeu comprends `r nrow(allsujet_clean.dat)` lignes pour `r length(unique(substr(allsujet_clean.dat$Id_cart, 1,7)))` sujets. La distribution du nombre d'adresses par sujet (\@ref(fig:histonbadressemax)) présente une queue de distribution légérement decentrée sur la droite avec un mode autour de sa moyenne (6,3 adresses/sujet). 

(ref:histonbadressemax) Distribution du nombre d'adresses par sujet

```{r histonbadressemax, fig.cap="(ref:histonbadressemax)", fig.align = 'center'}
allsujet_clean.dat %>% 
    mutate(ID_VISITE = as.numeric(str_extract(allsujet_clean.dat$Id_cart, pattern = "[0-9]{1,2}?$")),
           ID_SECONDAIRE = substr(allsujet_clean.dat$Id_cart, 1,7)) %>% 
    dplyr::group_by(ID_SECONDAIRE) %>% 
    dplyr::summarize(nb_adresse = max(ID_VISITE)) %>% 
    ggplot(aes(nb_adresse)) +
    geom_histogram(binwidth = 1, color = "white" ) +
    labs(x = "Nombre maximum d'adresses",
         y = "Nombre")
```


Il nous faut ici nous attarder sur la notion "d'adresse". Pour le moment cette dernière est juste une incrémentation lors d'un changement d'adresse ou lors d'un passage dans une résidence secondaire. Ainsi le sujet 01_0001 a pour adresse, dans l'ordre, "1", "2", "3", "4", "5". Qu'importe si "3" et son retour à "1" et que "5" correspond à sa résidence de vacances (où il peut y aller presque tous les ans). 

Il va être important pour la base de données de clarifier cela et de bien considerer que l'on a bien une seule adresse mais distincte en dates.



# Traitements de géocodage

Il y a eu deux traitements un effectué par le CLB via ESRI [ref] et un effectué par EVS via l'API d'Etalab [ref]. 

Avant de les présenter nous pouvons regarder les sujets comportants trops de valeurs manquantes risquant de rendre tout geocodage imposible. 

## Valeurs manquantes du jeu de données.

Il y a `nrow allsujet_clean.dat[is.na(allsujet_clean.dat$Commune),]` communes d'adresse manquantes
Le graphique n \@ref(fig:adressemanquantes) représente la répartition des valeurs manquantes dans le numero d'adresse. On peut constater que la majorité des cas est pour la première adresse. 

(ref:adressemanquantes) Répartition des valeurs manquantes par "Numéro d'adresse"

```{r adressemanquantes, fig.cap="(ref:adressemanquantes)", fig.align = 'center'}
allsujet_clean.dat %>% 
    mutate(Nun_adresse = as.numeric(str_extract(allsujet_clean.dat$Id_cart, pattern = "[0-9]{1,2}?$"))) %>% 
    filter(is.na(allsujet_clean.dat$Commune)) %>% 
    ggplot(aes(x = Nun_adresse)) +
    geom_histogram(binwidth = 1, color = "white" ) +
    labs(y = "Nombre")
```




## Geocodage

```{r chargementgeocodage, include=FALSE}
geocodage_evs.shp <- sf::st_read("../data/geocodev2.geojson", stringsAsFactors = FALSE)
geocodage_clb.shp <- sf::st_read("../data/Geocoding_Result.shp", stringsAsFactors = FALSE)
```

